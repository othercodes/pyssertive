name: Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Check formatting
        run: uv run ruff format --check src/ tests/

      - name: Check linting
        run: uv run ruff check src/ tests/

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run mypy
        run: uv run mypy src/pyssertive
        continue-on-error: true

  test:
    name: Test (py${{ matrix.python-version }}, dj${{ matrix.django-version }})
    runs-on: ubuntu-latest
    needs: [lint]

    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "3.11"
            django-version: "4.2"
          - python-version: "3.12"
            django-version: "5.0"
          - python-version: "3.13"
            django-version: "5.1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --all-extras
          uv pip install "Django~=${{ matrix.django-version }}.0"

      - name: Run tests
        run: uv run pytest --cov=pyssertive --cov-report=term-missing --cov-report=xml:coverage.xml --cov-fail-under=100

      - name: Upload coverage artifact
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, sonarcloud]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          echo "===== Job Results ====="
          echo "Lint:       ${{ needs.lint.result }}"
          echo "Typecheck:  ${{ needs.typecheck.result }}"
          echo "Test:       ${{ needs.test.result }}"
          echo "SonarCloud: ${{ needs.sonarcloud.result }}"
          echo "======================="

          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Lint failed"
            exit 1
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Tests failed"
            exit 1
          fi

          if [ "${{ needs.typecheck.result }}" == "failure" ]; then
            echo "⚠️ Typecheck failed (non-blocking)"
          fi

          if [ "${{ needs.sonarcloud.result }}" == "failure" ]; then
            echo "⚠️ SonarCloud failed (non-blocking)"
          fi

          echo "✅ All required checks passed!"
